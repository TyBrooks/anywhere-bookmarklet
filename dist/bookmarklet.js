!function(){function t(t){this.resources=t.resources||[],this.campaigns=[],this.campaignInfo={},this.serverDomain=viglink_dev?viglink_localhost:"http://anywhere-bookmarklet.herokuapp.com",this.defaultCampaign=t.defaultCampaign||null}function e(t){this.constructor(t)}function n(){}viglink_dev=!0,viglinkServeLocal=!1,viglink_localhost="//localhost:3000";var o=viglink_dev?viglink_localhost:"http://anywhere-bookmarklet.herokuapp.com";t.prototype.loadJQuery=function(t){var e=document.createElement("script"),n=!1,o=this;e.className="bkml-resource",e.src=this.serverDomain+"/javascripts/vendor/jquery-1.11.1.js",e.onload=e.onreadystatechange=function(){n||this.readyState&&"loaded"!==this.readyState||(n=!0,jq$=window.jq$=window.jQuery.noConflict(!0),window.XDomainRequest&&!jq$.support.cors&&o.shimAjaxIE(window.jq$),t())},document.getElementsByTagName("head")[0].appendChild(e)},t.prototype.shimAjaxIE=function(t){t.ajaxTransport(function(e){if(e.crossDomain&&e.async){e.timeout&&(e.xdrTimeout=e.timeout,delete e.timeout);var n;return{send:function(o,i){function a(e,o,a,r){n.onload=n.onerror=n.ontimeout=n.onprogress=t.noop,n=void 0,t.event.trigger("ajaxStop"),i(e,o,a,r)}n=new XDomainRequest,n.open(e.type,e.url),n.onload=function(){var t=200,e=n.responseText,o=n.responseText;o.StatusCode&&o.Message&&(t=o.StatusCode,e=o.Message),a(t,e,{text:e},"Content-Type: "+n.contentType)},n.onerror=function(){a(500,"Unable to Process Data")},n.onprogress=function(){},e.xdrTimeout&&(n.ontimeout=function(){a(0,"timeout")},n.timeout=e.xdrTimeout),n.send(e.hasContent&&e.data||null)},abort:function(){n&&(n.onerror=t.noop(),n.abort())}}}})},t.prototype.ajax=function(t,e,n){var o=jq$.Deferred();return jq$.ajax(t,jq$.extend({dataType:e,success:function(t){o.resolve(t)},timeout:3e3,attempts:0,attemptLimit:2,error:function(t,e,n){if("timeout"==e){if(this.attempts+=1,this.attempts<=this.attemptsLimit)return void jq$.ajax(this);o.reject(t,e,n)}else o.reject(t,e,n)}},{jsonp:n})),o},t.prototype.loadResources=function(){var t=jq$.Deferred(),e=this;return promises=[],this.resources.forEach(function(t){var n=t[1],o=t[0];if("js"===n){var i=e.loadJSResource(o);promises.push(i)}else if("css"===n){var i=e.loadCSSResource(o);promises.push(i)}else if("html"===n){var i=e.loadHTMLResource(o);promises.push(i)}}),jq$.when.apply(jq$,promises).then(function(e){t.resolve(e)}).fail(function(t,n){alert("Bookmarklet Error: There was an error loading the required resources"),console.log("Bookmarklet Error: "+n),console.log(t),e.remove()}),t},t.prototype.loadHTMLResource=function(t){var e=this.ajax(t,"html");return e},t.prototype.loadCSSResource=function(t){var e=jq$.Deferred();$bkml_style=jq$("<link></link>").addClass("bkml-resource").attr("rel","stylesheet").attr("type","text/css").attr("href",t),jq$("head").append($bkml_style);var n=setInterval(function(){e.reject({reason:"cssTimeout"},"Error: CSS Load timeout",t)},5e3);return $bkml_style.on("load",function(){clearInterval(n),e.resolve()}).on("error",function(){clearInterval(n),e.reject()}),e},t.prototype.loadJSResource=function(t){var e=this.ajax(t,"script");return e},t.prototype.callJsonAPI=function(t){var e=this.ajax(t,"json");return e},t.prototype.callJsonpAPI=function(t,e){var n=this.ajax(t,"jsonp",e);return n},t.prototype.sendLogData=function(){},t.prototype.attach=function(t){jq$("body").append(t)},t.prototype.remove=function(){this.slideUp(),setTimeout(function(){jq$(".bkml-container").remove(),jq$(".bkml-resource").remove(),jq$(".global-zeroclipboard-container").remove(),delete window.viglink_bkml},1e3)},t.prototype.slideDown=function(){jq$(".bkml-container").removeClass("bkml-container-hidden")},t.prototype.slideUp=function(){jq$(".bkml-container").addClass("bkml-container-hidden")},t.prototype.logEvent=function(t){console.log(t);var e=(jq$("#bkml-campaign-select").val()||window.viglink_default_campaign||null,{bookmarklet:{et:t.type,uid:t.user,url:window.location.href}});this.sendLogData(e)},t.prototype.sendLogData=function(t){var e="http://qa-api-va-1.ec2.viglink.com:8080",n="/api/pixel.gif";jq$.ajax(e+n,{contentType:"application/x-www-form-urlencoded; charset=UTF-8",method:"POST",data:{events:JSON.stringify(t)},success:function(){console.log("EVENT LOGGED")},error:function(){}})},n.prototype=t.prototype,e.prototype=new n,e.prototype.grabResources=function(){var t=this,e=this.grabUserData(),n=this.loadResources(),o=this.grabLinkData();jq$.when(e,n).then(this.loadHTML.bind(t,o)).fail(function(){t.logEvent({type:"Load Failure",user:window.viglink_user}),alert("Bookmarklet Error: There was a problem accessing our servers. Try again later!"),t.remove()})},e.prototype.loadHTML=function(t,e,n){var o=jq$(n),i=this;i.isSignedIn(e)?(this.createCampaignHash(o,e),t.done(function(t){i.isAffiliatable(t)?(i.logEvent({type:"Load Success",user:window.viglink_user}),i.buildSharePageHTML(o,i.campaigns),i.initializeShareEvents(o),i.showSharePage(o),i.attach(o)):(i.logEvent({type:"Load NotAff",user:window.viglink_user}),i.initializeNotAffiliatableEvents(o),i.showNotAffiliatablePage(o),i.attach(o))}).fail(function(){i.logEvent({type:"Load Failure",user:window.viglink_user}),alert("Bookmarklet Error: There was a problem accessing our servers. Try again later!")})):(i.logEvent({type:"Load NotLogged",user:window.viglink_user}),i.initializeLoginEvents(o,t),i.showLoginPage(o),i.attach(o)),i.initializeGeneralEvents(o),setTimeout(function(){i.slideDown()},10)},e.prototype.createCampaignHash=function(t,e){var n=e.users,o=this;this.campaigns=[],n.forEach(function(t){var e=t.name;o.campaigns.push(e),o.campaignInfo[e]=o.campaignInfo[e]||{},o.campaignInfo[e].key=t.key,o.campaignInfo[e].userId=t.id}),this.campaigns.length>10&&t.find(".bkml-campaign-filter-container").css({display:"block"})},e.prototype.buildSharePageHTML=function(t,e){this.buildCampaignOptions(t,e);var n=this.getAnywhereizedURL(t);this.setNewLink(t,n)},e.prototype.buildCampaignOptions=function(t,e){t.find("#bkml-campaign-select").empty();var n=this;e.forEach(function(e){$option=jq$('<option val="'+n.campaignInfo[e].key+'">'+e+"</option>"),e===n.defaultCampaign&&$option.attr("selected","selected"),t.find("#bkml-campaign-select").append($option)})},e.prototype.getAnywhereizedURL=function(t){var e=this.selectedCampaignKey(t),n=this.campaignInfo[e].key,o=this.anywhereizeURL(n);return o},e.prototype.anywhereizeURL=function(t){return"http://redirect.viglink.com?key="+t+"&type=bk&u="+encodeURIComponent(window.location.href)},e.prototype.setNewLink=function(t,e){var n=t.find(".bkml-link-shorten");n.removeData("short"),this.setShortenButtonAttrs(n,"long",e),this.insertLinkIntoHTML(t,e)},e.prototype.insertLinkIntoHTML=function(t,e){t.find(".bkml-link-text").text(e),t.find(".bkml-link-copy").data("clipboard-text",e),this.formatTwitterLink(t.find(".bkml-social-tweet"),e),this.formatFbLink(t.find(".bkml-social-fb"),e)},e.prototype.formatTwitterLink=function(t,e){t.attr("href","https://twitter.com/share?url="+encodeURIComponent(e))},e.prototype.formatFbLink=function(t,e){var n="https://www.facebook.com/sharer.php?src=bm&v=4&i=1406665647&u="+encodeURIComponent(e)+"&t="+encodeURIComponent(document.title);t.attr("href",n)},e.prototype.initializeShareEvents=function(t){this.initializeClipboard(t),t.find(".bkml-link-copy").on("click",function(t){t.preventDefault()}),t.find(".bkml-link-shorten").on("click",this.handleShortenClick.bind(this,t));var e=this;t.find("#bkml-campaign-select").on("change",function(){var n=e.getAnywhereizedURL(jq$(".bkml-container"));e.setNewLink(t,n);var o=jq$(this).val(),i=e.campaignInfo[o].shortUrl;if(i){var a=t.find(".bkml-link-shorten");a.data("short",i)}}),t.find("#bkml-campaign-filter").on("change",function(){var n=$(this).val(),o=e.campaigns.filter(function(t){return-1!==t.indexOf(n)});e.buildCampaignOptions(t,o),t.find("#bkml-campaign-select").trigger("change")}),t.find(".bkml-campaign-form").on("submit",function(t){t.preventDefault()}),t.find(".bkml-social-button").on("click",function(){var n=$(this).data("social");e.logEvent({type:"Share "+n,user:e.campaignInfo[e.selectedCampaignKey(t)].userId})})},e.prototype.handleShortenClick=function(t){var e=(t.find(".bkml-link-text"),t.find(".bkml-link-shorten")),n='<i class="fa fa-circle-o-notch fa-spin"></i>',o=this;if("long"!==e.data("active")||e.data("short"))"short"===e.data("active")?(this.setShortenButtonAttrs(e,"long",e.data("long")),this.insertLinkIntoHTML(t,e.data("long"))):(this.setShortenButtonAttrs(e,"short",e.data("short")),this.insertLinkIntoHTML(t,e.data("short")));else{e.html(n);var i=this.grabBitlyData(e.data("long"));i.done(function(n){if("short"!==e.data("active")&&n.data&&n.data.url){var i=n.data.url;o.setShortenButtonAttrs(e,"short",i),o.insertLinkIntoHTML(t,i);var a=o.selectedCampaignKey(t);o.campaignInfo[a].shortUrl=i}}).always(function(){e.html()===n&&o.setShortenButtonAttrs(e,"long",e.data("long"))})}},e.prototype.setShortenButtonAttrs=function(t,e,n){t.data("active",e),"short"===e?t.data("short",n).text("Lengthen"):"long"===e?t.data("long",n).text("Shorten"):t.text("Not a valid campaign")},e.prototype.initializeClipboard=function(t){var e=this,n=t.find(".bkml-link-copy");window.ZeroClipboard.config({swfPath:this.serverDomain+"/swf/ZeroClipboard.swf",trustedDomains:[window.location.protocol+"//"+window.location.host],containerId:"global-zeroclipboard-html-bridge-VL",swfObjectId:"global-zeroclipboard-flash-bridge-VL"});var o=new window.ZeroClipboard(t.find("#clipboard-target"));o.on("ready",function(){o.on("aftercopy",function(){e.logEvent({type:"Copy Auto",user:e.campaignInfo[e.selectedCampaignKey(t)].userId}),alert("Formatted URL has been copied!")})}),o.on("error",e.initializeAlternateCopyHandlers.bind(e,n))},e.prototype.initializeAlternateCopyHandlers=function(t,e){var n=this;t.unbind("click"),t.on("click",function(){n.logEvent({type:"Copy Manual",user:n.campaignInfo[n.selectedCampaignKey($bkmlSnippet)].userId});var o=t.data("clipboard-text");window.prompt("Clipboard Error: "+e.message+"\n\nPress Ctrl + C to copy link manually.",o)})},e.prototype.initializeLoginEvents=function(t,e){var n=this;t.find("#bkml-reload-button").on("click",function(){var o=jq$(this),i=o.html(),a='<i class="fa fa-circle-o-notch fa-spin" style="position: absolute; right: 21px; top: 13px;"></i>';o.off("click").html(o.html()+a);var r=n.grabUserData();r.done(function(a){o.html(i),n.loadHTML(e,a,t)})})},e.prototype.initializeNotAffiliatableEvents=function(t){var e=this;t.find("#bkml-close-button").on("click",function(){e.remove()})},e.prototype.initializeGeneralEvents=function(t){var e=this;t.find(".bkml-dismiss").on("click",function(){e.remove()})},e.prototype.showSharePage=function(t){t.find(".bkml-share-page").css("display","inline-block"),t.find(".bkml-login-page").css("display","none"),t.find(".bkml-notaff-page").css("display","none")},e.prototype.showLoginPage=function(t){t.find(".bkml-login-page").css("display","inline-block"),t.find(".bkml-share-page").css("display","none"),t.find(".bkml-notaff-page").css("display","none")},e.prototype.showNotAffiliatablePage=function(t){t.find(".bkml-notaff-page").css("display","inline-block"),t.find(".bkml-login-page").css("display","none"),t.find(".bkml-share-page").css("display","none")},e.prototype.grabLinkData=function(){var t="9cb01deed662e8c71059a9ee9a024d30",e=viglinkServeLocal?viglink_localhost+"/api/link":"http://api.viglink.com/api/link",n=encodeURIComponent(window.location.href),o="jsonp",i="jsonp",a=e+"?out="+n+"&format="+o+"&key="+t+"&optimize=false",r=viglinkServeLocal?this.callJsonAPI(a,i):this.callJsonpAPI(a,i);return r},e.prototype.grabUserData=function(){var t=viglinkServeLocal?viglink_localhost+"/account/users":"http://publishers.viglink.com/account/users",e="callback",n=t,o=viglinkServeLocal?this.callJsonAPI(n,e):this.callJsonpAPI(n,e);return o},e.prototype.grabBitlyData=function(t){var e="a2dde94fc7b3fc05e7a1dfc24d8d68840f013793",n="https://api-ssl.bitly.com/v3/shorten?ACCESS_TOKEN="+e+"&longUrl="+encodeURIComponent(t),o="callback",i=window.viglink_bkml.callJsonpAPI(n,o);return i},e.prototype.isSignedIn=function(t){return!!t.users},e.prototype.isAffiliatable=function(t){return!!t.affiliatable},e.prototype.selectedCampaignKey=function(t){return t.find("#bkml-campaign-select").val()};var i=[[o+"/bookmarklet","html"],[o+"/javascripts/vendor/ZeroClipboard-VL.js","js"],[o+"/stylesheets/bookmarklet.css","css"],["//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css","css"]],a={resources:i};window.viglink_default_campaign&&(a.defaultCampaign=unescape(window.viglink_default_campaign)),anywhereBkml=window.viglink_bkml=new e(a),anywhereBkml.loadJQuery(anywhereBkml.grabResources.bind(anywhereBkml))}();